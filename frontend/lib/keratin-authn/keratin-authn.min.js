/* eslint-disable */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).KeratinAuthN={})}(this,function(e){"use strict";function o(t){return Object.keys(t).map(function(e){return function(e,t){if(void 0!==t)return e+"="+encodeURIComponent(t)}(e,t[e])}).filter(function(e){return void 0!==e}).join("&")}function n(t,n){return s(function(e){e.open("GET",(t+"?"+o(n)).replace(/\?$/,"")),e.send()})}function i(t,n){return s(function(e){e.open("POST",t),e.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),e.send(o(n))})}function s(e){return new Promise(function(t,n){var o=new XMLHttpRequest;o.withCredentials=!0,o.onreadystatechange=function(){var e;o.readyState===XMLHttpRequest.DONE&&("errors"in(e=1<o.responseText.length?JSON.parse(o.responseText):{})?n(e.errors):400<o.status?n([{message:o.status.toString()}]):t(e.result))},e(o)})}var r=!1,t="";function u(e){return"username"===e.field&&"TAKEN"===e.message}function a(){return t=f("/session"),s(function(e){e.open("DELETE",t),e.send()});var t}function f(e){if(!t.length)throw"ISSUER not set";return""+t+e}var c=(h.prototype.iat=function(){return 1e3*this.claims.iat},h.prototype.exp=function(){return 1e3*this.claims.exp},h.prototype.halflife=function(){return(this.exp()-this.iat())/2},h);function h(e){this.token=e,this.claims=function(e){try{return JSON.parse(atob(e.split(".")[1]))}catch(e){throw"Malformed JWT: invalid encoding"}}(e)}var d=(p.prototype.setStore=function(e){this.store=e},p.prototype.sessionToken=function(){if(this.store)return this.store.read()},p.prototype.update=function(e){this.store&&(this.store.update(e),e=new c(e),this.refreshAt=Date.now()+e.halflife(),this.scheduleRefresh())},p.prototype.endSession=function(){this.refreshAt=void 0,this.timeoutID&&clearTimeout(this.timeoutID),this.store&&this.store.delete()},p.prototype.restoreSession=function(){var s=this;return new Promise(function(e,t){if(s.store){var n=s.sessionToken();if(n){var o=Date.now(),i=new c(n),n=i.iat()+i.halflife();if(isNaN(n))return s.store.delete(),void t("Malformed JWT: can not calculate refreshAt");n<=o||o<i.iat()?s.refresh().then(e,t):(s.refreshAt=n,s.scheduleRefresh(),e())}else t("No session.")}else t("No session storage available.")})},p.prototype.refresh=function(){var t=this;return n(f("/session/refresh"),{}).then(function(e){return e.id_token}).then(function(e){return t.update(e)},function(e){throw e[0]&&"401"===e[0].message&&t.endSession(),e})},p.prototype.scheduleRefresh=function(){var e=this;this.timeoutID&&clearTimeout(this.timeoutID),this.refreshAt&&(this.timeoutID=setTimeout(function(){return e.refresh().catch(function(e){if(!e[0]||"401"!==e[0].message)throw e})},this.refreshAt-Date.now()))},p);function p(){var e=this;"undefined"!=typeof document&&document.addEventListener("visibilitychange",function(){"visible"===document.visibilityState&&e.scheduleRefresh()})}var l=(m.prototype.read=function(){if("undefined"!=typeof document)return document.cookie.replace(new RegExp("(?:(?:^|.*;\\s*)"+this.sessionName+"\\s*\\=\\s*([^;]*).*$)|^.*$"),"$1")},m.prototype.update=function(e){"undefined"!=typeof document&&(document.cookie=this.sessionName+"="+e+this.secureFlag+this.path+this.domain+this.sameSite)},m.prototype.delete=function(){"undefined"!=typeof document&&(document.cookie=this.sessionName+"=; expires=Thu, 01 Jan 1970 00:00:01 GMT"+this.secureFlag+this.path+this.domain+this.sameSite)},m);function m(e,t){void 0===t&&(t={}),this.sessionName=e,this.path=t.path?"; path="+t.path:"",this.domain=t.domain?"; domain="+t.domain:"",this.sameSite=t.sameSite?"; SameSite="+t.sameSite:"","undefined"!=typeof window&&(this.secureFlag="https:"===window.location.protocol?"; secure":"")}var w=new d;e.changePassword=function(e){return e=e,i(f("/password"),e).then(function(e){return e.id_token}).then(function(e){return w.update(e)})},e.importSession=function(){return w.refresh()},e.isAvailable=function(e){return n(f("/accounts/available"),{username:e}).then(function(e){return e}).catch(function(e){if(!(e instanceof Error)&&e.some(u))return!1;throw e})},e.login=function(e){return e=e,i(f("/session"),e).then(function(e){return e.id_token}).then(function(e){return w.update(e)})},e.logout=function(){return a().then(function(){return w.endSession()})},e.requestPasswordReset=function(e){return n(f("/password/reset"),{username:e})},e.requestSessionToken=function(e){return n(f("/session/token"),{username:e})},e.resetPassword=function(e){return e=e,i(f("/password"),e).then(function(e){return e.id_token}).then(function(e){return w.update(e)})},e.restoreSession=function(){return w.restoreSession()},e.session=function(){return w.sessionToken()},e.sessionTokenLogin=function(e){return e=e,i(f("/session/token"),e).then(function(e){return e.id_token}).then(function(e){return w.update(e)})},e.setCookieStore=function(e,t){t=new l(e,t),w.setStore(t)},e.setHost=function(e){t=e.replace(/\/$/,"")},e.signup=function(e){return o=e,new Promise(function(t,n){r?n([{message:"duplicate"}]):(r=!0,i(f("/accounts"),o).then(function(e){return t(e.id_token)},function(e){return n(e)}).then(function(){return r=!1}))}).then(function(e){return w.update(e)});var o},Object.defineProperty(e,"__esModule",{value:!0})});
